name: pre-release sample install test

on:
  workflow_dispatch:

jobs:
  install-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install lint tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      - name: Lint
        run: |
          shellcheck -s sh install.sh || true
          shellcheck -s bash .tools/install.sh || true
          shfmt -d . || true
          cue vet -c=false .tools/schema/mise-seq.cue .tools/tools.yaml -d '#MiseSeqConfig' || true

      - name: Install mise
        run: |
          curl https://mise.run | sh
        env:
          MISE_DEPS_CURL: "0"

      - name: Setup mise PATH
        run: |
          MISE_SHIMS="${HOME}/.local/share/mise/shims"
          MISE_BIN="${HOME}/.local/bin"
          echo "${MISE_SHIMS}" >> $GITHUB_PATH
          echo "${MISE_BIN}" >> $GITHUB_PATH
          # Verify PATH includes mise tools
          which mise
          export PATH="${MISE_SHIMS}:${MISE_BIN}:$PATH"
          mise ls

      - name: Setup isolated mise dirs
        run: |
          echo "MISE_DATA_DIR=${RUNNER_TEMP}/mise-data" >> $GITHUB_ENV
          echo "MISE_INSTALLS_DIR=${RUNNER_TEMP}/mise-data/installs" >> $GITHUB_ENV
          echo "MISE_CACHE_DIR=${RUNNER_TEMP}/mise-cache" >> $GITHUB_ENV

      - name: Run sample install (repo-provided .tools/tools.yaml)
        run: |
          ./.tools/install.sh
